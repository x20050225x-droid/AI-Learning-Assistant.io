<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å­¸ç¿’åŠ©ç† - ä¸€é å¼æ¥µé€Ÿç‰ˆ</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 { color: var(--primary); text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #6b7280; font-size: 0.9em; margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        /* æ¸¬é©—å€æ¨£å¼ */
        .hidden { display: none; }
        .option-btn {
            background: white;
            border: 2px solid #e5e7eb;
            color: var(--text);
            text-align: left;
            margin-bottom: 10px;
        }
        .option-btn:hover:not(:disabled) { border-color: var(--primary); background: #eff6ff; }
        .option-btn.correct { background-color: #dcfce7; border-color: #22c55e; color: #14532d; }
        .option-btn.wrong { background-color: #fee2e2; border-color: #ef4444; color: #7f1d1d; }
        
        .feedback {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>AI å­¸ç¿’åŠ©ç†</h1>
    <div class="subtitle">è‡ªå‹•é¡Œåº«ç”Ÿæˆç³»çµ± (One-Page Version)</div>

    <div id="setup-panel" class="card">
        <label>1. è¼¸å…¥ Gemini API Key</label>
        <input type="password" id="apiKey" placeholder="è²¼ä¸Šä½ çš„ AIza é–‹é ­é‡‘é‘°...">
        
        <label>2. å­¸ç¿’æ•™æå…§å®¹</label>
        <textarea id="content" rows="6" placeholder="è«‹è²¼ä¸Šæ–‡ç« ã€ç­†è¨˜æˆ–é‡é»æ•´ç†..."></textarea>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label>é¡Œå‹</label>
                <select id="qType">
                    <option value="é¸æ“‡é¡Œ">é¸æ“‡é¡Œ</option>
                    <option value="æ˜¯éé¡Œ">æ˜¯éé¡Œ</option>
                </select>
            </div>
            <div>
                <label>é¡Œæ•¸</label>
                <input type="number" id="qCount" value="3" min="1" max="5">
            </div>
        </div>

        <button id="generateBtn" onclick="startGeneration()">ğŸš€ é–‹å§‹ç”Ÿæˆæ¸¬é©—</button>
    </div>

    <div id="quiz-panel" class="card hidden">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; color: #6b7280;">
            <span id="progress">é¡Œç›® 1/3</span>
            <span id="score">å¾—åˆ†: 0</span>
        </div>
        <h3 id="question-text" style="font-size: 1.2em; line-height: 1.5; margin-bottom: 20px;">é¡Œç›®è¼‰å…¥ä¸­...</h3>
        <div id="options-container"></div>
        
        <div id="feedback-area" class="feedback hidden">
            <p id="explanation" style="margin: 0;"></p>
            <button onclick="nextQuestion()" style="margin-top: 10px; width: auto; padding: 8px 20px;">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="result-panel" class="card hidden" style="text-align: center;">
        <h2>æ¸¬é©—çµæŸï¼</h2>
        <div style="font-size: 3em; color: var(--primary); font-weight: bold; margin: 20px 0;" id="final-score">100%</div>
        <p id="comment">åˆ†æä¸­...</p>
        <button onclick="location.reload()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    // --- ç³»çµ±æ ¸å¿ƒé‚è¼¯ ---
    let questions = [];
    let currentIdx = 0;
    let score = 0;

    // 1. å‘¼å« API
    async function startGeneration() {
        const key = document.getElementById('apiKey').value.trim();
        const text = document.getElementById('content').value.trim();
        const type = document.getElementById('qType').value;
        const count = document.getElementById('qCount').value;

        if (!key || !text) {
            alert("è«‹è¼¸å…¥ API Key å’Œæ•™æå…§å®¹ï¼");
            return;
        }

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.textContent = "ğŸ¤– AI æ­£åœ¨é–±è®€ä¸¦å‡ºé¡Œä¸­...";

        // æ§‹å»º Prompt
        const prompt = `
            ä½ æ˜¯ä¸€å€‹å°ˆæ¥­æ•™å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹ç”Ÿæˆ ${count} é¡Œ ${type}ã€‚
            ã€å…§å®¹ã€‘ï¼š${text}
            
            ã€åš´æ ¼è¦å‰‡ã€‘ï¼š
            1. å¿…é ˆå›å‚³ç´” JSON é™£åˆ—ã€‚
            2. ä¸è¦ä½¿ç”¨ Markdown (ä¸è¦æœ‰ \`\`\`json )ã€‚
            3. æ ¼å¼ç¯„ä¾‹ï¼š
            [{"question":"é¡Œç›®","options":["A","B","C","D"],"answer":0,"explanation":"è§£æ"}]
            (answer æ˜¯æ­£ç¢ºé¸é …çš„ç´¢å¼•ï¼Œ0ä»£è¡¨ç¬¬ä¸€å€‹é¸é …)
        `;

        // ä½¿ç”¨ gemini-1.5-flash
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error?.message || "API è«‹æ±‚å¤±æ•—");
            }

            // è§£æå›æ‡‰
            const rawText = data.candidates[0].content.parts[0].text;
            // æ¸…ç† Markdown
            const cleanText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            
            try {
                questions = JSON.parse(cleanText);
            } catch (e) {
                // å¦‚æœ JSON å£äº†ï¼Œå˜—è©¦ä¿®å¾© (è£œå°¾æ‹¬è™Ÿ)
                if(cleanText.includes('[') && !cleanText.endsWith(']')) {
                    questions = JSON.parse(cleanText + ']');
                } else {
                    throw new Error("AI å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦");
                }
            }

            if(questions.length > 0) {
                initQuiz();
            } else {
                throw new Error("æ²’æœ‰ç”Ÿæˆä»»ä½•é¡Œç›®");
            }

        } catch (err) {
            console.error(err);
            alert(`ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}\n(å¦‚æœæ˜¯ 404ï¼Œè«‹ç¢ºèª API Key æ˜¯å¦é–‹é€šäº† Generative Language API)`);
            btn.textContent = "ğŸš€ é‡æ–°ç”Ÿæˆ";
            btn.disabled = false;
        }
    }

    // 2. æ¸¬é©—é‚è¼¯
    function initQuiz() {
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('quiz-panel').classList.remove('hidden');
        currentIdx = 0;
        score = 0;
        renderQuestion();
    }

    function renderQuestion() {
        if (currentIdx >= questions.length) {
            showResult();
            return;
        }
        
        const q = questions[currentIdx];
        document.getElementById('progress').textContent = `é¡Œç›® ${currentIdx + 1} / ${questions.length}`;
        document.getElementById('question-text').textContent = q.question;
        document.getElementById('feedback-area').classList.add('hidden');
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';

        // é˜²å‘†ï¼šå¦‚æœæ˜¯æ˜¯éé¡Œä½† AI çµ¦äº† 4 å€‹é¸é …ï¼Œæˆ–æ˜¯åéä¾†
        let opts = q.options;
        if (!opts || opts.length === 0) opts = ["æ˜¯", "å¦"];

        opts.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => check(idx, btn, q.answer);
            container.appendChild(btn);
        });
    }

    function check(userIndex, btn, ansIndex) {
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.disabled = true);

        if (userIndex === ansIndex) {
            btn.classList.add('correct');
            score++;
            document.getElementById('score').textContent = `å¾—åˆ†: ${score}`;
        } else {
            btn.classList.add('wrong');
            if(btns[ansIndex]) btns[ansIndex].classList.add('correct');
        }

        document.getElementById('explanation').textContent = `ğŸ’¡ è§£æï¼š${questions[currentIdx].explanation}`;
        document.getElementById('feedback-area').classList.remove('hidden');
    }

    function nextQuestion() {
        currentIdx++;
        renderQuestion();
    }

    function showResult() {
        document.getElementById('quiz-panel').classList.add('hidden');
        document.getElementById('result-panel').classList.remove('hidden');
        
        const finalPercent = Math.round((score / questions.length) * 100);
        document.getElementById('final-score').textContent = `${finalPercent}%`;
        
        let msg = "";
        if(finalPercent === 100) msg = "å¤ªç¥å•¦ï¼å…¨å°ï¼ğŸ‰";
        else if(finalPercent >= 60) msg = "ä¸éŒ¯å–”ï¼Œç¹¼çºŒä¿æŒï¼ğŸ’ª";
        else msg = "å†è¤‡ç¿’ä¸€ä¸‹æ•™æå§ï¼ğŸ“š";
        
        document.getElementById('comment').textContent = msg;
    }
</script>

</body>
</html>